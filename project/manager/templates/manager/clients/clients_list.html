{% load static humanize index %}

<style> 
    /* 
    Generic Styling, for Desktops/Laptops 
    */
    table {
      width: 100%;
      border-collapse: collapse;
    }



    th {
      background: #333;
      color: white;
      font-weight: bold;
    }

    td, th {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }

    /* 
    Max width before this PARTICULAR table gets nasty
    This query will take effect for any screen smaller than 760px
    and also iPads specifically.
    */
    @media only screen and (max-width: 760px), (min-device-width: 768px) and (max-device-width: 1024px) {
      .responsive-table-input-matrix {
        display: block;
        position: relative;
        width: 100%;
      }
      .responsive-table-input-matrix:after {
        clear: both;
        content: "";
        display: block;
        font-size: 0;
        height: 0;
        visibility: hidden;
      }
      .responsive-table-input-matrix tbody {
        display: block;
        overflow-x: auto;
        position: relative;
        white-space: nowrap;
        width: auto;
      }
      .responsive-table-input-matrix tbody tr {
        display: inline-block;
        vertical-align: top;
      }
      .responsive-table-input-matrix tbody tr td {
        display: block;
        text-align: center;
      }
      .responsive-table-input-matrix tbody tr td:first-child {
        text-align: center;
      }
      .responsive-table-input-matrix thead {
        display: block;
        float: left;
        margin-right: 10px;
      }
      .responsive-table-input-matrix thead:after {
        clear: both;
        content: "";
        display: block;
        font-size: 0;
        height: 0;
        visibility: hidden;
      }
      .responsive-table-input-matrix thead th:first-of-type {
        height: 1.4em;
      }
      .responsive-table-input-matrix thead th {
        display: block;
        text-align: center;
      }
      .responsive-table-input-matrix thead th:first-child {
        text-align: center;
      }
    }
</style>
<style>
  .board-ordered tr > *:nth-child(2) {
    display: none;
}
</style>
<style>
  .draggable-grip{
    vertical-align: middle;
  }

  .draggable-grip:after {
    width: 3%;
    position: relative;
    text-align: center;
    content: '\f58d';
    font-family: 'Font Awesome\ 5 Free';
    font-weight: 900;
  }
</style>

<style>


  
  #resizable {
    resize: horizontal;
    overflow: auto;
    height:65px;
    min-width: -webkit-fill-available;
    display: block;
    position:relative;
    z-index:1;
  
  }
  

</style>


    <h3>
        Clients
        <button
          class="btn btn-info align-content-center mx-3 unique-add-btn"
          type="button"
          id="createClient"
          >
          Ajouter
        </button>
    </h3>
    {% regroup clients by circuit as client_list %}
      {% for circuit, clients_by_circuit in client_list %}
        <table class="responsive-table-input-matrix table table-hover board-ordered" id="table-{{forloop.counter0}}">
          
            <thead class="table-dark position-relative" {% if forloop.counter0 > 0 %} style="visibility:collapse;"{% else %}style="z-index:1; opacity:1;"{% endif %}>
                <tr>
                    <th>#</th>
                    <th>#</th>
                    <th>Nom</th>
                    <th {% if forloop.counter0 == 0 %}id="resizable"{% else %}class="follow-resizing d-block"{% endif %}>Adresse</th>
                    <th {% if forloop.counter0 == 0 %}id="reference_height"{% endif %}>Tel</th>
                    {% with foodcategories as foodcategories %}
                    {% for food in formDefaultCommand %}
                        <th  style="width: 0px;" class="verticalTableHeader">
                                    {{ food.default.category }}
                        </th>
                        {% endfor %}
                    {% endwith %}
                    <th style="width: 0px;" >Tournée</th>
                    <th>€/u</th>
                    <th>Nb. Repas</th>
                    <th>€ ce mois</th>
                    {% comment %} <th>Export</th> {% endcomment %}
                </tr>
            </thead>
          
          <tbody class="overflow-auto">
            {% ifchanged clients_by_circuit.circuit %}
              {% if forloop.counter0 != 0 %}
                <tr style="border-collapse: separate; border-spacing:0 20px;">
                  <td colspan="17">
                  </td>
                </tr>
              {% endif %}
            {% endifchanged %}
          {% for client in clients_by_circuit %}
            <tr style="background-color: ; margin-bottom:1rem; background-color:{{gradients|get_value:circuit.id}}">
                <td style="vertical-align: middle;" class="draggable draggable-grip">
                </td>
                <td style="vertical-align: middle;"><input class="order_clients" type="text" name="order__{{client.id}}" id="order__{{client.id}}" value="{{forloop.counter0}}"/></td>
                <td style="vertical-align: middle;">
                  <input type="text" style="inline-size: -webkit-fill-available;" name="last_name__{{client.id}}" id="last_name__{{client.id}}" value="{{client.last_name}}"/></br>
                  <input type="text" style="inline-size: -webkit-fill-available;" name="first_name__{{client.id}}" id="first_name__{{client.id}}" value="{{client.first_name}}"/>
                </td>
                <td style="vertical-align: middle;">
                  <input type="text" style="inline-size: -webkit-fill-available;" name="address__{{client.id}}" id="address__{{client.id}}" value="{{client.address}}"/><br>
                  <input type="text" style="inline-size: -webkit-fill-available;" name="postcode__{{client.id}}" id="postcode__{{client.id}}" value="{{client.postcode}}"/>
                </td>
                <td style="vertical-align: middle;">
                  <input type="text" style="inline-size: -webkit-fill-available;" name="cellphone__{{client.id}}" id="cellphone__{{client.id}}" value="{{client.cellphone}}"/><br>
                  <input type="text" style="inline-size: -webkit-fill-available;" name="cellphone2__{{client.id}}" id="cellphone2__{{client.id}}" value="{{client.cellphone2}}"/>
                </td>
                {% for default in formDefaultCommand %}
                    <td style="-webkit-writing-mode: vertical-lr;">
                        <input
                            type="checkbox"
                            style="transform: scale(2); vertical-align: sub;"
                            id="_meals__{{default.id}}__{{client.id}}"
                            name="_meals__{{default.id}}__{{client.id}}"
                        {% for box_client in client.client_command.all %}
                            {% if default|striptags == box_client|striptags %}
                                checked
                            {% endif %}
                        {% endfor %}
                            class="default_box">
                    </td>
                {% endfor %}
                <td style="vertical-align: middle;">
                    <select name="circuit_id__{{client.id}}" id="circuit_id__{{client.id}}">
                        {% for circuit in circuits %}
                            <option value="{{ circuit.id }}" {% if circuit.id == client.circuit.id %}selected="selected"{% endif %}> {{ circuit.name }} </option>
                        {% endfor %}
                    </select>
                </td>
                <td style="vertical-align: middle;">
                  {% if client.client_command.all|make_unit_price %}
                    <strong>{{client.client_command.all|make_unit_price}}</strong>
                  {% else %}
                    <strong>0</strong>
                  {% endif %}
                </td>
                {% with actual_day as day %}
                {% with day|day as this_day %}
                {% with day|month as this_month %}
                {% with day|year as this_year %}
                <td style="vertical-align: middle;">
                  <strong>{{month_commands|make_query|query_filter_month_date_command:this_month|query_filter_year_date_command:this_year|query_filter_client_id:client.id|query_sum_meals_this_month}}</strong>
                </td>
                <td style="vertical-align: middle;">
                  {% if month_commands|make_query|query_filter_month_date_command:this_month|query_filter_year_date_command:this_year|query_filter_client_id:client.id|query_sum_price_this_month %}
                    <strong>{{month_commands|make_query|query_filter_month_date_command:this_month|query_filter_year_date_command:this_year|query_filter_client_id:client.id|query_sum_price_this_month}}</strong>
                  {% else %}
                    <strong>0</strong>
                  {% endif %}
                </td>
                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% comment %} <td><button
                  class="btn btn-warning align-content-center mx-3"
                  type="button">
                  Excel à l'unitée
                </button></td> {% endcomment %}
            </tr>
            {% endfor %}
          </table>
          {% endfor %}

{% regroup clients by circuit as client_list %}
{% for circuit, clients_by_circuit in client_list %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.getElementById('table-{{forloop.counter0}}');

      let draggingEle;
      let draggingRowIndex;
      let placeholder;
      let list;
      let isDraggingStarted = false;

      // The current position of mouse relative to the dragging element
      let x = 0;
      let y = 0;

      // Swap two nodes
      const swap = function (nodeA, nodeB) {
          const parentA = nodeA.parentNode;
          const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;

          // Move `nodeA` to before the `nodeB`
          nodeB.parentNode.insertBefore(nodeA, nodeB);

          // Move `nodeB` to before the sibling of `nodeA`
          parentA.insertBefore(nodeB, siblingA);

      };

      // Check if `nodeA` is above `nodeB`
      const isAbove = function (nodeA, nodeB) {
          // Get the bounding rectangle of nodes
          const rectA = nodeA.getBoundingClientRect();
          const rectB = nodeB.getBoundingClientRect();

          return rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2;
      };

      const cloneTable = function (e) {
          const rect = table.getBoundingClientRect();
          const width = parseInt(window.getComputedStyle(table).width);
          list = document.createElement('div');
          list.classList.add('clone-list');
          list.style.position = 'absolute';
          list.style.left = `${rect.left}px`;
          list.style.top = `${rect.top + window.scrollY}px`;
          table.parentNode.insertBefore(list, table);

          // Hide the original table
          table.style.visibility = 'hidden';

          table.querySelectorAll('tr').forEach(function (row) {
              // Create a new table from given row
              const item = document.createElement('div');
              item.classList.add('draggable');

              const newTable = document.createElement('table');
              newTable.setAttribute('class', 'clone-table');
              newTable.style.width = `${width}px`;

              const newRow = document.createElement('tr');
              const cells = [].slice.call(row.children);
              cells.forEach(function (cell) {
                  const newCell = cell.cloneNode(true);
                  newCell.style.width = `${parseInt(window.getComputedStyle(cell).width)}px`;
                  newRow.appendChild(newCell);
              });

              newTable.appendChild(newRow);
              item.appendChild(newTable);
              list.appendChild(item);
          });
      };

      const mouseDownHandler = function (e) {
          // Get the original row
          const originalRow = e.target.parentNode;
          draggingRowIndex = [].slice.call(table.querySelectorAll('tr')).indexOf(originalRow);

          // Determine the mouse position
          x = e.clientX;
          y = e.clientY;

          // Attach the listeners to `document`
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
      };

      const mouseMoveHandler = function (e) {
          if (!isDraggingStarted) {
              isDraggingStarted = true;

              cloneTable();

              draggingEle = [].slice.call(list.children)[draggingRowIndex];
              draggingEle.classList.add('dragging');

              // Let the placeholder take the height of dragging element
              // So the next element won't move up
              placeholder = document.createElement('div');
              placeholder.classList.add('placeholder');
              draggingEle.parentNode.insertBefore(placeholder, draggingEle.nextSibling);
              placeholder.style.height = `${draggingEle.offsetHeight}px`;
          }

          // Set position for dragging element
          draggingEle.style.position = 'absolute';
          draggingEle.style.top = `${draggingEle.offsetTop + e.clientY - y}px`;
          draggingEle.style.left = `${draggingEle.offsetLeft + e.clientX - x}px`;

          // Reassign the position of mouse
          x = e.clientX;
          y = e.clientY;

          // The current order
          // prevEle
          // draggingEle
          // placeholder
          // nextEle
          const prevEle = draggingEle.previousElementSibling;
          const nextEle = placeholder.nextElementSibling;

          // The dragging element is above the previous element
          // User moves the dragging element to the top
          // We don't allow to drop above the header
          // (which doesn't have `previousElementSibling`)
          if (prevEle && prevEle.previousElementSibling && isAbove(draggingEle, prevEle)) {
              // The current order    -> The new order
              // prevEle              -> placeholder
              // draggingEle          -> draggingEle
              // placeholder          -> prevEle
              swap(placeholder, draggingEle);
              swap(placeholder, prevEle);
              return;
          }

          // The dragging element is below the next element
          // User moves the dragging element to the bottom
          if (nextEle && isAbove(nextEle, draggingEle)) {
              // The current order    -> The new order
              // draggingEle          -> nextEle
              // placeholder          -> placeholder
              // nextEle              -> draggingEle
              swap(nextEle, placeholder);
              swap(nextEle, draggingEle);
          }
      };

      const mouseUpHandler = function () {
          // Remove the placeholder
          placeholder && placeholder.parentNode.removeChild(placeholder);

          draggingEle.classList.remove('dragging');
          draggingEle.style.removeProperty('top');
          draggingEle.style.removeProperty('left');
          draggingEle.style.removeProperty('position');

          // Get the end index
          const endRowIndex = [].slice.call(list.children).indexOf(draggingEle);

          isDraggingStarted = false;

          // Remove the `list` element
          list.parentNode.removeChild(list);

          // Move the dragged row to `endRowIndex`
          let rows = [].slice.call(table.querySelectorAll('tr'));
          draggingRowIndex > endRowIndex
              ? rows[endRowIndex].parentNode.insertBefore(rows[draggingRowIndex], rows[endRowIndex])
              : rows[endRowIndex].parentNode.insertBefore(
                    rows[draggingRowIndex],
                    rows[endRowIndex].nextSibling
                );


          // Bring back the table
          table.style.removeProperty('visibility');

          // Remove the handlers of `mousemove` and `mouseup`
          document.removeEventListener('mousemove', mouseMoveHandler);
          document.removeEventListener('mouseup', mouseUpHandler);
          let counter0 = 0;
          table.querySelectorAll('.order_clients').forEach(function(order) {
            console.log(order)
            order.setAttribute('value', counter0);
            counter0 += 1;
        });
      };

      table.querySelectorAll('tr').forEach(function (row, index) {
          // Ignore the header
          // We don't want user to change the order of header
          {% if forloop.counter0 == 0 %}
            if (index === 0) {
                return;
            }          
          {% endif %}


          const firstCell = row.firstElementChild;
          firstCell.classList.add('draggable');
          firstCell.addEventListener('mousedown', mouseDownHandler);
      });
  });

  </script>
{% endfor %}